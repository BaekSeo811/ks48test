<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ksmart.mybatis.mapper.GoodsMapper">

	<resultMap type="Goods" id="goodsResultMap">
		<id property="goodsCode" column="g_code"/>
		<result property="goodsName" column="g_name"/>
		<result property="goodsPrice" column="g_price"/>
		<result property="goodsSellerId" column="g_seller_id"/>
		<result property="goodsRegDate" column="g_reg_date"/>
		
		<!-- 고급맵핑 1:1관계에서만 사용 가능한 association DTO예)Member memberInfo-->
		<association property = "memberInfo" javaType="Member">
			<id property="memberId" column="m_id"></id>
			<result property="memberPw" column="m_pw"/>
			<result property="memberName" column="m_name"/>
			<result property="memberLevel" column="m_level"/>
			<result property="memberLevelName" column="m_level_name"/>
			<result property="memberEmail" column="m_email"/>
			<result property="memberAddr" column="m_addr"/>
			<result property="memberRegDate" column="m_reg_date"/>
		</association>
	</resultMap>
	
	<!-- 상품등록 -->
	<!-- selectkey keyProperty:DTO 속성명, resultType: 속성의 데이터타입, order:insert 실행 전(BEFORE),후(AFTER) 선택-->
	<insert id="addGoods" parameterType="Goods">
		<selectKey keyProperty="goodsCode" resultType="String" order="BEFORE">
			/* 상품코드 자동증가 */
			SELECT
				(CASE
				WHEN COUNT(g.g_code) = 0 THEN 'g001'
				WHEN (MAX(CAST(SUBSTRING_INDEX(g.g_code,'g',-1) AS UNSIGNED))+1) > 999
				THEN CONCAT('g', MAX(CAST(SUBSTRING_INDEX(g.g_code,'g',-1) AS UNSIGNED))+1)
				ELSE
					CONCAT ('g', LPAD(MAX(CAST(SUBSTRING_INDEX(g.g_code,'g',-1) AS UNSIGNED))+1,3,'0'))
				END) AS goodsCode
			FROM
				tb_goods AS g
		</selectKey>
		/* 상품등록 */
		INSERT INTO tb_goods
		(g_code, g_name, g_price, g_seller_id, g_reg_date)
		values
		(#{goodsCode}, #{goodsName}, #{goodsPrice}, #{goodsSellerId}, CURDATE())
	</insert>
	
	<!-- 상품 목록 조회 -->
	<select id="getGoodsList" resultMap="goodsResultMap">
		SELECT 
			g.g_code, 
			g.g_name, 
			g.g_price, 
			g.g_seller_id, 
			g.g_reg_date,
			m.m_id, 
			m.m_pw, 
			m.m_name, 
			m.m_level, 
			m.m_email, 
			m.m_addr, 
			m.m_reg_date
		FROM 
			tb_goods AS g
			INNER JOIN 
			tb_member AS m
			ON
			g.g_seller_id = m.m_id;
	</select>
	

</mapper>